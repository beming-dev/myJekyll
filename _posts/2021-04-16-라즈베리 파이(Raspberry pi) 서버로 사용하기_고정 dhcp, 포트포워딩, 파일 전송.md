---
layout: post
category: 라즈베리파이
thumbnail: 라즈베리파이.png
tags: [Raspberry pi, Ubuntu server, scp, dhcp, port forwarding]
typora-copy-images-to: assets\images
typora-root-url: ./
---

지난번에 Docker가 잘 실행되는 것까지 확인을 했으니, 이제 실제 내 프로젝트를 올려두고 외부접속이 가능하게 하면 완성이다.

프로젝트를 라즈베리 파이에 올릴때, 당연히 라즈베리파이에 접속해서 Vim같은걸로 작업해도 되겠지만 그러는 사람은 아마 아무도 없을거다.. 나도 pc에서 vscode로 작업을 하고, scp명령을 통해 라즈베리파이로 파일을 보냈다.

외부접속을 허용하기 위해서는 고정dhcp와 ddns로 라즈베리파이의 ip를 고정하고, 포트포워딩을 해서 외부접속이 되도록 하면 된다.

<br/><br/>

# 라즈베리파이로 파일 전송

scp명령어를 사용하면 원격으로 파일을 전송할 수 있다. ssh와 동일한 22번 포트로 파일을 전송해서 보안성도 괜찮다고 한다.

```shell
scp -r [전송할 폴더 위치] [목적지]
```

이런 식으로 작성하면 전송이 된다. 

나는 내 데스크탑에서

```shell
scp -r [폴더위치] ubuntu@192.168.35.5:/home/docker-nodeapp
```

이런식으로 작성을 해줬다. -r은 폴더를 전송하는 옵션이고, 제외하면 파일을 전송하는 명령이 된다.

디렉토리에서 파일을 다 꺼내야 되기 때문에 파일을 전송한 후에는 docker-nodeapp 위치에서

```shell
cd [폴더이름]
mv [폴더이름] * ..
cd ..
rm [폴더이름]
```

이런 명령어로 파일을 다 꺼내놓고 빈 폴더를 지웠다.

<br/><br/>

# 외부 접속 허용하기

먼저 내 라즈베리파이에 ip가 부여되는 방식을 간단히 보자.

ip주소는 개수가 42억개 정도로 한정돼있기 때문에 모든 기기에 직접 ip를 부여할 수가 없다. 그래서 공유기에 하나의 ip를 주고 공유기가 내부적으로 가상 ip를 할당해서 공유기에 접속한 기기들에게 나눠준다. (아래 그림 참고)

![KakaoTalk_20210416_111343943_01 (2)](/assets/images/KakaoTalk_20210416_111343943_01 (2).jpg)

외부에서 내 라즈베리 파이에 접속하려면 ip주소를 알아야 하는데, 이 ip주소는 고정이 아니다. 공유기에 접속을 끊었다가 다시 접속하면 위 그림의 2번 주소가 바뀌고, 할당된 ip를 오래동안 사용하지 않으면 통신사에서 위 그림의 1번 ip도 바꿔버린다. 

만약 내가 친구한테 xxx.xxx.xxx.xxx ip로 접속하면 내 웹사이트가 뜰거야~ 하고 알려줬는데 ip가 바뀐다면 같은 주소를 사용해도 접속이 되지 않을것이다.

그래서 고정 dhcp를 사용해서 2번 ip를 고정하고, ddns로 1번 ip가 바뀌는것을 감지해야 한다.

ddns는 iptime공유기에서는 공유기 관리자 페이지에서 지원을 하지만 대부분의 공유기는 지원을 하지 않는다. 나는 iptime을 쓰지 않아서 그냥 ddns는 하지 않았다. 실제 서비스할 사이트도 아니고, 1번 ip는 사실 자주 바뀌진 않기 때문이다.



## 고정 dhcp

cmd에 들어가서 ipconfig명령어를 친 후 기본 게이트웨이 라고 써있는 부분의 ip를 주소창에 입력하면 공유기 관리자 페이지에 접속이 가능하다.

구글링으로 자기 공유기에 맞는 id, pw를 찾아낸 후 접속한다.

ui는 공유기 페이지마다 다르지만, dhcp가 써진 탭을 클릭해보면 고정 dhcp를 줄 수 있는 부분이 있을거다.

공유기에 연결된 라즈베리파이의 물리 주소(알파벳, 숫자로 XX-XX-XX-XX-XX 이런식으로 생김) 를 적어두고 고정 dhcp를 치는 부분에 이 물리주소와 고정할 ip를 치고 등록하면 고정 dhcp가 설정된다.



## 포트포워딩

포트포워딩도 마찬가지로 공유기 관리자 페이지에 항목이 있다.

![화면 캡처 2021-04-15 092735](/assets/images/화면 캡처 2021-04-15 092735.png)

보통 이런식으로 생겼는데, 내부 ip주소에 아까 고정한 dhcp의 ip주소를 입력하고 외부포트에는 적당히 안쓰는 포트 번호, 내부 포트에는 22번포트에 하나 만들고, 서버를 띄울때 사용한 포트에 하나 만들자.

다 만들면 대충 이렇게 생겼을거다.

![KakaoTalk_20210416_111343943 (2)](/assets/images/KakaoTalk_20210416_111343943 (2).jpg)

# 끝

각자 만들어 둔 Docker file대로 docker image를 만들고 실행해서 서버를 띄워둔 다음, 

주소창에 ip주소:포트포워딩한 포트로 접속하면 이제 내가 만든 서버가 외부에서도 접속이 가능하다..

라고 끝내면 좋겠지만 결과적으로 나는 외부접속을 가능하게 하는걸 실패했다. 서버를 띄우는것까진 성공했고, 내부ip로는 접속이 되는데 포트포워딩을 해도 외부 ip로는 접속이 되지 않았다.

한참을 구글링 해본 결과, 우리 집 공유기가 sk공유기인데 폐쇄형 NAT방식이라 포트포워딩이 제대로 작동을 안한다는 것 같다.

이를 해결하려면 DMZ나 브릿지를 사용해야 하는데, 둘 다 보안등에 문제가 있어서 그냥 시도하지 않았다. 나 혼자 쓰는 공유기가 아니라 함부로 건들 수가 없었다. 나중에 공유기를 iptime으로 바꾸거나 해야겠다.