---
layout: post
category: React+NodeJS
thumbnail: reactNodeJS.jpg
tags: [Ract, NodeJS]
typora-copy-images-to: assets\images
typora-root-url: ./
---

쇼핑몰 프로젝트를 진행하던 중, 오류가 생겨 정말 시간을 많이 날렸다. 



# 사건의 발단

로그인 과정을 구현하던 중, 분명히 로그인이 성공한것까지는 확인이 되는데 sission에 저장하고 클라이언트로 넘겨주려 했더니 session에 아무것도 기록돼있지 않는 것이었다.

분명 session을 사용하는 코드는 이전 커뮤니티 만들기 프로젝트에서는 잘 작동했는데, 똑같이 세팅해도 여기선 안되니 미칠 노릇이었다.



# 원인 찾기

그래서 req.session의 log를 찍어봤는데 session은 잘 존재했다. 이게 말이 되나..? session에 값을 기록하고 바로 찍어보면 기록한 겂이 log에 찍히는데, 그 값을 다른 요청에서 사용하려고 보면 사라져 있는 것이었다.

그래서 나는 내가 중간에 session을 삭제하는 뭘 넣었나 싶어 코드를 다 뒤져봤지만 그런게 있을리가 없었다.

이것저것 해도 다 안되서 결국은 DB에 들어가서 session테이블을 찍어봤다. 그랬더니..

![화면 캡처 2021-04-21 172624](/assets/images/화면 캡처 2021-04-21 172624.png)

아마 session에 row가 257개가 있는 광경을 본 사람은 얼마 없을거다. 이걸보고 아 내가 session을 호출할 때마다 session이 새로 생성되고 있구나 싶어서 테스트 해봤더니 역시 sessoin이 계속 만들어지고 있었다.

새로 만들어진 session에는 값이 기록되있지 않으니 log를 찍어도 이상한 값이 나오는 거였다.

그래서 다시 왜 sesison이 복제되는지에 대해 검색을 했는데 나랑 비슷한 상황인 사람도 많지 않았고, 그나마 찾은 답들도 하나같이 해결해주지 못했다.

그러다가 답변들이 대부분 cookie가 전송되지 않아서 그런다고 말하는걸 발견했고, 이에 대해 다시 검색을 시작했다.

# 해결

session도 여러개가 존재할 수 있기 때문에 우리가 session을 생성하면 위에 사진의 맨 왼쪽 column에 있는 값처럼 id가 부여된다. 

그러면 session들을 식별하기 위해 클라이언트에 쿠키형태로 session id를 저장한다.

나는 서버와 클라이언트 사이에 데이터를 주고 받기 위해 cors라는 패키지를 포함해 사용했는데, 이 cors정책에서는 기본적으로 쿠키를 전송하지 못하도록 설정이 되어있다.

그래서 session id가 구분되지 않으니까 어떤 session을 말하는건지 찾지 못하고 계속 새로운 session을 만들어내는, 뭐 그런식의 에러인것 같았다.

그래서 server.js에서 cors를 호출하는 부분에

```javascript
app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true,
}));
```

이렇게 설정을 해주고,

fetch API에서도

```javascript
fetch("http://localhost:3001/api/isLogined", {
    method: 'post',
	credentials: 'include'
})
```

이런식으로 작성을 했더니  session이 복제되지 않고 잘 해결됐다.



근데 이상하게도 처음 구글링할때도 credentials 쿠키 전송을 허용하는 옵션을 계속 줬었는데 그땐 그래도 안됐었다. 그때랑 달라진건 cors의 origin옵션 정도인데 방금 origin을 빼고 테스트 해봤는데 이상하게 잘 됐다. 정확히 어떤것들이 영향을 주는지는 지금부터 조금 더 테스트 해봐야겠다.



# 끝

조금 찝찝하지만 아무튼 원인도 알았고 해결도 했으니 만족한다.

이 오류를 해결하는데에  6~7시간정도가 들었다. 이것보다 더 시간을 써본 적도 있지만 이번 오류는 특히 더 머리가 아팠다.

코딩을 하다보면 종종 이렇게 한 오류를 잡는데 엄청 많은 시간을 써야하는 경우가 있다. 물론 내 경험치가 쌓이면 비슷한 오류에는 시간이 별로 안걸릴 것이고, 다른 오류들도 좀 더 빠른 시간에 잡을 수 있게 될거다. 하지만 아직 그 정도 수준까진 한참 남은 것 같다ㅎㅎ. 

이렇게 오래 에러를 잡다보면 물론 엄청 힘들고 다른 일도 손에 안잡히고 그러지만 나름 배우는게 많기도 하다. 특히 오류를 해결했을 때의 기분은 정말정말 좋다. 

그러니 코딩을할때 오류가 생기는걸 겁낼 필요는 없는것 같다(시간이 진짜 많이 들긴하지만..). 아무튼 이제 다시 프로젝트 진행 해야겠다~.

